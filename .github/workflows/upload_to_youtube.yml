name: YouTube Upload (OU Stock Parody)

on:
  schedule:
      # ë§¤ì¼ ì˜¤ì „ 5:30 KST (ì „ë‚  20:30 UTC)ì— ì‹¤í–‰
    - cron: '30 20 * * *'
  workflow_dispatch:

jobs:
  upload_to_youtube:
    runs-on: ubuntu-latest
    env:
      GSHEET_ID: ${{ secrets.GSHEET_ID }}
      GOOGLE_CREDENTIALS_JSON: ${{ secrets.GOOGLE_CREDENTIALS_JSON }}
      YOUTUBE_CLIENT_SECRETS: ${{ secrets.YOUTUBE_CLIENT_SECRETS }}
      YOUTUBE_TOKEN_JSON: ${{ secrets.YOUTUBE_TOKEN_JSON }}
      CLAUDE_API_KEY: ${{ secrets.CLAUDE_API_KEY }}
    steps:
      - name: ğŸ“¥ Checkout repository with LFS
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: ğŸ Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: ğŸ“¦ Install dependencies
        run: pip install -r youtube_uploader/requirements_youtube.txt

      - name: ğŸ” Restore YouTube authentication files
        run: |
          mkdir -p youtube_uploader
          echo "${{ secrets.YOUTUBE_CLIENT_SECRETS }}" > youtube_uploader/client_secrets.json
          printf "%s" '${{ secrets.YOUTUBE_TOKEN_JSON }}' > youtube_uploader/token.json

      - name: ğŸš€ Upload to YouTube
        run: python youtube_uploader/upload_to_youtube.py

      - name: ğŸ§¹ Clean up old video files (LFS aware)
        run: |
          echo "ğŸ§¹ ì˜¤ë˜ëœ ë¹„ë””ì˜¤ íŒŒì¼ ì •ë¦¬ ì¤‘ (LFS ê³ ë ¤)..."
          if [ -d "parody_video" ]; then
            # ê°€ì¥ ìµœê·¼ íŒŒì¼ ì°¾ê¸° (íŒŒì¼ëª… ê¸°ì¤€)
            latest_file=$(find parody_video -name "*.mp4" | while read file; do
              filename=$(basename "$file")
              date_part=$(echo "$filename" | grep -o '2025[0-9]{4}_[0-9]{6}' | head -1)
              if [ -n "$date_part" ]; then
                echo "$date_part $file"
              else
                echo "00000000000000 $file"  # ì‹œê°„ì •ë³´ ì—†ëŠ” íŒŒì¼ì€ ë§¨ ë’¤ë¡œ
              fi
            done | sort -r | head -1 | cut -d' ' -f2-)
            
            if [ -n "$latest_file" ]; then
              echo "ğŸ“¹ ìµœì‹  íŒŒì¼ ë³´ì¡´: $(basename "$latest_file")"
              
              # ì˜¤ë˜ëœ íŒŒì¼ë“¤ ì‚­ì œ (LFS íŒŒì¼ í¬í•¨)
              deleted_count=0
              for file in parody_video/*.mp4; do
                if [ -f "$file" ] && [ "$file" != "$latest_file" ]; then
                  echo "ğŸ—‘ï¸ ì‚­ì œ ì‹œë„: $(basename "$file")"
                  
                  # LFS untrack ë¨¼ì € ì‹œë„
                  git lfs untrack "$file" 2>/dev/null || true
                  
                  # íŒŒì¼ ì‚­ì œ ì‹œë„
                  if rm "$file" 2>/dev/null; then
                    echo "   âœ… ì‚­ì œ ì™„ë£Œ: $(basename "$file")"
                    deleted_count=$((deleted_count + 1))
                  else
                    echo "   âš ï¸ ì‚­ì œ ì‹¤íŒ¨: $(basename "$file") (ê¶Œí•œ ë¬¸ì œ ë˜ëŠ” LFS íŒŒì¼)"
                  fi
                fi
              done
              echo "âœ… ì •ë¦¬ ì™„ë£Œ: $deleted_countê°œ íŒŒì¼ ì‚­ì œë¨"
            else
              echo "âš ï¸ parody_video í´ë”ì— mp4 íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤."
            fi
          else
            echo "âš ï¸ parody_video ë””ë ‰í† ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤."
          fi

      - name: ğŸ“Š CSV íŒŒì¼ ìƒíƒœ í™•ì¸
        run: |
          echo "ğŸ“Š CSV íŒŒì¼ ìƒíƒœ í™•ì¸ ì¤‘..."
          if [ -d "csv_data" ]; then
            csv_count=$(find csv_data -name "*.csv" -type f | wc -l)
            if [ $csv_count -gt 0 ]; then
              echo "ğŸ“„ í˜„ì¬ CSV íŒŒì¼ ê°œìˆ˜: $csv_countê°œ"
              echo "ğŸ“‹ CSV íŒŒì¼ ëª©ë¡:"
              ls -la csv_data/*.csv
            else
              echo "âš ï¸ csv_data í´ë”ì— CSV íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤."
            fi
          else
            echo "âš ï¸ csv_data ë””ë ‰í† ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤."
          fi

      - name: ğŸ“ Commit and push changes
        run: |
          echo "ğŸ“ ë³€ê²½ì‚¬í•­ ì»¤ë°‹ ë° í‘¸ì‹œ ì¤‘..."
          git add -A
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git commit -m "ğŸ¬ YouTube ì—…ë¡œë“œ ì™„ë£Œ - $(date +'%Y-%m-%d %H:%M')" || echo "âš ï¸ ì»¤ë°‹ ì‹¤íŒ¨ (ë³€ê²½ì‚¬í•­ ì—†ìŒ)"
          git push || echo "âš ï¸ í‘¸ì‹œ ì‹¤íŒ¨"

      - name: ğŸ§¹ Clean up LFS storage
        run: |
          echo "ğŸ§¹ Git LFS ì €ì¥ ê³µê°„ ì •ë¦¬ ì¤‘..."
          git lfs prune --force
          echo "âœ… LFS ì •ë¦¬ ì™„ë£Œ"
