name: YouTube Upload (OU Stock Parody)

on:
  schedule:
      # ë§¤ì¼ ì˜¤ì „ 6:30 KST (ì „ë‚  21:30 UTC)ì— ì‹¤í–‰
    - cron: '30 21 * * *'
  workflow_dispatch:

jobs:
  upload_to_youtube:
    runs-on: ubuntu-latest
    env:
      GSHEET_ID: ${{ secrets.GSHEET_ID }}
      GOOGLE_CREDENTIALS_JSON: ${{ secrets.GOOGLE_CREDENTIALS_JSON }}
      YOUTUBE_CLIENT_SECRETS: ${{ secrets.YOUTUBE_CLIENT_SECRETS }}
      YOUTUBE_TOKEN_JSON: ${{ secrets.YOUTUBE_TOKEN_JSON }}
      CLAUDE_API_KEY: ${{ secrets.CLAUDE_API_KEY }}
    steps:
      - name: ğŸ“¥ Checkout repository with LFS
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: ğŸ Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: ğŸ“¦ Install dependencies
        run: pip install -r youtube_uploader/requirements_youtube.txt

      - name: ğŸ” Restore YouTube authentication files
        run: |
          mkdir -p youtube_uploader
          echo "${{ secrets.YOUTUBE_CLIENT_SECRETS }}" > youtube_uploader/client_secrets.json
          printf "%s" '${{ secrets.YOUTUBE_TOKEN_JSON }}' > youtube_uploader/token.json

      - name: ğŸš€ Upload to YouTube
        run: python youtube_uploader/upload_to_youtube.py

      - name: ğŸ§¹ Clean up old video files
        run: |
          echo "ğŸ§¹ parody_video í´ë”ì—ì„œ ìµœê·¼ LFS íŒŒì¼ë§Œ ë‚¨ê¸°ê³  ì´ì „ íŒŒì¼ë“¤ ì‚­ì œ ì¤‘..."
          
          # parody_video í´ë”ë¡œ ì´ë™
          cd parody_video
          
          # .mp4 íŒŒì¼ë“¤ ì¤‘ ê°€ì¥ ìµœê·¼ íŒŒì¼ ì°¾ê¸° (ìˆ˜ì • ì‹œê°„ ê¸°ì¤€)
          latest_file=$(ls -t *.mp4 2>/dev/null | head -1)
          
          if [ -n "$latest_file" ]; then
            echo "ğŸ“¹ ìµœê·¼ íŒŒì¼: $latest_file"
            
            # ìµœê·¼ íŒŒì¼ì„ ì œì™¸í•œ ëª¨ë“  .mp4 íŒŒì¼ ì‚­ì œ
            for file in *.mp4; do
              if [ "$file" != "$latest_file" ]; then
                echo "ğŸ—‘ï¸ ì‚­ì œ: $file"
                rm "$file"
              fi
            done
            
            echo "âœ… ì •ë¦¬ ì™„ë£Œ! ìµœê·¼ íŒŒì¼ë§Œ ë‚¨ê²¼ìŠµë‹ˆë‹¤."
          else
            echo "âš ï¸ ì‚­ì œí•  .mp4 íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤."
          fi

      - name: ğŸ§¹ Clean up Git LFS history
        run: |
          echo "ğŸ§¹ Git LFS íˆìŠ¤í† ë¦¬ì—ì„œ ì´ì „ íŒŒì¼ë“¤ ì •ë¦¬ ì¤‘..."
          
          # parody_video í´ë”ì˜ .mp4 íŒŒì¼ë“¤ ì¤‘ ìµœê·¼ íŒŒì¼ ì°¾ê¸°
          cd parody_video
          latest_file=$(ls -t *.mp4 2>/dev/null | head -1)
          
          if [ -n "$latest_file" ]; then
            echo "ğŸ“¹ ìµœê·¼ íŒŒì¼: $latest_file"
            
            # Git LFSì—ì„œ ìµœê·¼ íŒŒì¼ì„ ì œì™¸í•œ ëª¨ë“  .mp4 íŒŒì¼ ì œê±°
            for file in *.mp4; do
              if [ "$file" != "$latest_file" ]; then
                echo "ğŸ—‘ï¸ LFSì—ì„œ ì œê±°: $file"
                git lfs untrack "$file" 2>/dev/null || true
                git rm --cached "$file" 2>/dev/null || true
              fi
            done
            
            # ë³€ê²½ì‚¬í•­ ì»¤ë°‹
            git config --global user.email "action@github.com"
            git config --global user.name "GitHub Action"
            git add -A
            git commit -m "ğŸ§¹ LFS íŒŒì¼ ì •ë¦¬: ìµœê·¼ íŒŒì¼ë§Œ ìœ ì§€" || true
            
            echo "âœ… LFS íˆìŠ¤í† ë¦¬ ì •ë¦¬ ì™„ë£Œ!"
          else
            echo "âš ï¸ LFSì—ì„œ ì •ë¦¬í•  .mp4 íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤."
          fi
